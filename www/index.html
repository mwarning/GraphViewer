<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8">
	<title>Graph Viewer</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" href="leaflet-1.3.4.css"/>

	<script src="leaflet-1.3.4.js"></script>

	<!-- Source: http://d3js.org -->
	<script src="d3.v5.min.js"></script>
	<script src="rbush-2.0.2.min.js"></script>

	<script src="utils.js"></script>
	<script src="sidebar.js"></script>
	<script src="selection.js"></script>

	<script src="forcegraph.js"></script>
	<script src="forcegraph/draw.js"></script>

	<script src="map.js"></script>
	<script src="map/button.js"></script>
	<script src="map/activearea.js"></script>
	<script src="map/clientlayer.js"></script>
	<script src="map/labellayer.js"></script>
	<script src="map/locationmarker.js"></script>

	<script>
		var config = {
		mapLayers: [{
			'name': 'OpenStreetMap.HOT',
			'url': 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
			'config': {
				'maxZoom': 19,
				'attribution': '&copy; Openstreetmap France | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}
		}],
		clientZoom: 15,
		nodeZoom: 18,
		geo: null,
		fixedCenter: [
			// Northwest
			[-5.0, 5.0],
			// Southeast
			[5.0, -5.0]
		],
		map_tqFrom: '#F02311',
		map_tqTo: '#04C714',
		fullscreen: true,
		fullscreenFrame: true
	};

	var sidebar;
	var buttons;
	var selection;
	var my_graph;
	var my_map;
	var my_data = {nodes:[], links: []};


	function removeGraph () {
		send("/cmd/clear", {}, function() {
				request_graph();
			}
		);
	}

	function disconnectSelectedNodes () {
		var node_ids = selection.getSelectedNodes();
		send("/cmd/call", { cmd: "disconnect", nodes: node_ids }, function() {
			request_graph();
		});
	}

	function connectSelectedNodes () {
		var node_ids = selection.getSelectedNodes();
		send("/cmd/call", { cmd: "connect", nodes: node_ids }, function() {
			request_graph();
		});
	}

	// Remove selected items
	function removeSelectedItems () {
		var node_ids = selection.getSelectedNodes();
		var links_ids = selection.getSelectedLinks();

		send("/cmd/call", { cmd: "remove", links: link_ids, nodes: node_ids }, function() {
			request_graph();
		});
	};

	function showMap() {
		if (my_graph) {
			my_graph.destroy();
			my_graph = null;
		}
		var linkScale = d3.interpolate(config.map_tqFrom, config.map_tqTo);
		var parent = $('#content');
		my_map = createMap(parent, selection, linkScale, sidebar, buttons);
		my_map.resetView();
		my_map.setData(my_data);
	}

	function showGraph() {
		if (my_map) {
			my_map.destroy();
			my_map = null;
		}
		var parent = $('#content');
		my_graph = createGraph(parent, selection, sidebar);
		my_graph.setData(my_data);
	}

	//from js/gui.js
	//TODO: use static html
	function attachButtonsDiv() {
		/*
		<div class="buttons">
		<button class="ion-eye" title="Switch View"></button>
		<button class="ion-full-enter" title="Toggle Fullscreen"></button>
		</div>
		*/
		var buttons = document.createElement('div');
		buttons.classList.add('buttons');

		var buttonToggle = document.createElement('button');
		buttonToggle.classList.add('ion-eye');
		buttonToggle.setAttribute('title', 'Switch View');
		buttonToggle.appendChild(document.createTextNode("S"));
		buttonToggle.onclick = function onclick() {
		if (my_graph) {
			showMap();
		} else {
			showGraph();
		}
		};

		buttons.appendChild(buttonToggle);

		if (config.fullscreen || config.fullscreenFrame && window.frameElement) {
			var buttonFullscreen = document.createElement('button');
			buttonFullscreen.classList.add('ion-full-enter');
			buttonFullscreen.setAttribute('title', 'Toggle Fullscreen');
			buttonFullscreen.appendChild(document.createTextNode("F"));
			buttonFullscreen.onclick = function onclick() {
				toggleFullscreen(buttonFullscreen);
			};

			buttons.appendChild(buttonFullscreen);
		}

		return buttons;
	}

	function handle_data(data) {
		var json = {};
		try {
			json = JSON.parse(data);
		} catch (e) {
			console.log(e);
		}

		if (json.nodes && json.links) {
			// remove selected items that do not exist anymore
			selection.filterSelections(json.nodes, json.links);

			if (my_graph) {
				my_graph.setData(json);
				my_data = json;
			}

			if (my_map) {
				my_map.setData(json);
				my_data = json;
			}
		}
	}

	function request_graph() {
		send("/cmd/graph", {}, function(data) {
			handle_data(data);
		});
	}

	function run_update_loop() {
		var interval_ms = 250;

		function looped_request_graph() {
			send("/cmd/graph", {}, function(data) {
				handle_data(data);
				setTimeout(looped_request_graph, interval_ms);
			});
		}

		looped_request_graph();
	}

	function init() {
		send("/config.json", {}, function(data) {
			config = Object.assign(config, JSON.parse(data));
			sidebar = createSidebar()();
			selection = createSelection();

			// extends leaflet with activearea
			createActiveArea();
			createClientLayer();

			buttons = attachButtonsDiv();
			document.getElementById('content').appendChild(buttons);

			showGraph();

			run_update_loop();
		});
	}
</script>
</head>
<body onload="init()">
	<div id="content" class="content">
	</div>

	<div class="sidebar hidden">
		<button class="sidebarhandle" title="Toggle Sidebar" onclick="sidebar.onClick();">&lt;</button>
		<div class="container">
			<fieldset>
				<legend>Change Selection</legend>
				<div>
					<input type="button" onclick="selection.extendSelection(my_data); if (my_graph) { my_graph.redraw(); }" value="extend" />
					<input type="button" onclick="selection.clearSelection(); if (my_graph) { my_graph.redraw(); }" value="unselect" />
				</div>
			</fieldset>
			<fieldset>
				<legend>Modify Graph</legend>
				<div>
					<input type="button" onclick="connectSelectedNodes();" value="connect" />
					<input type="button" onclick="disconnectSelectedNodes();" value="disconnect" />
					<input type="button" onclick="removeSelectedItems();" value="remove" />
				</div>
			</fieldset>
		</div>
	</div>

	<noscript>
		<strong>JavaScript required</strong>
	</noscript>
</body>
</html>
