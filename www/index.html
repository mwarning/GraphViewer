<!DOCTYPE html>

<html>
<head>
	<meta charset="utf-8">
	<title>MeshNet Simulator</title>
	<link rel="stylesheet" type="text/css" href="style.css">

	<!-- Source: http://d3js.org -->
	<script src="js/d3.v5.min.js"></script>

	<script src="js/ws.js"></script>
	<script src="js/chart.js"></script>
	<script src="js/utils.js"></script>
	<script src="js/draw.js"></script>
	<script src="js/graph.js"></script>
	<script src="js/file.js"></script>
	<script src="js/edit.js"></script>
	<script src="js/sim.js"></script>
	<script src="js/show.js"></script>
	<script src="js/control.js"></script>

	<script>
		var graph;
		var file;
		var edit;
		var sim;
		var show;
		var control;
		var chart;
		var stateid = 0;

		function globalUpdateGraph() {
			send('/cmd/graph', {}, function(data) {
				var json = JSON.parse(data);
				graph.updateGraph(json.nodes, json.links);
			});
		}

		// rename to updateData
		function globalUpdateNodes() {
			send('/cmd/nodes', {}, function(data) {
				var json = JSON.parse(data);
				graph.updateData(json.nodes);
			});
		}

		function globalUpdate() {
			globalUpdateGraph();
			globalUpdateNodes();
			// move out of sim
			sim.getAlgorithm();
			sim.updateStats();
		}

		function init() {
			// Select first tab
			document.getElementsByClassName('tablinks')[0].click();

			graph = createGraph('graph');
			chart = createChart('chart');
			file = createFile(graph);
			edit = createEdit(graph);
			sim = createSim(graph, chart);
			show = createShow(graph);
			control = createControl(graph);

			//poller();
			globalUpdate();
		}
	</script>
</head>
<body onload="init()">
	<div id="container">
		<div id="toolbar">
			<div class="tab">
				<!-- <button class="tablinks" onclick="send('/nodes.json', {}, function(data) {alert(data); });">Test</button>-->
				<button class="tablinks" onclick="showTab(event, 'file')">File</button>
				<button class="tablinks" onclick="showTab(event, 'edit')">Edit</button>
				<button class="tablinks" onclick="showTab(event, 'show')">Show</button>
				<button class="tablinks" onclick="showTab(event, 'control')">Control</button>
				<button class="tablinks" onclick="showTab(event, 'sim')">Simulate</button>
			</div>
			<div id="file" class="tabcontent">
				<fieldset>
					<legend>Load</legend>
					<div class="enum">
						<input type="button" onclick="file.loadData($('file_input').files, $('url_input').value)" value="Load" />
						<div>
							<input type="text" id="url_input" value="" />
							<input type="file" id="file_input" accept=".json" onchange="displayFileName(this);" />
							<label onclick="$('file_input').click()">Select</label>
						</div>
					</div>
				</fieldset>
				<fieldset>
					<legend>Save</legend>
					<div class="enum">
						<input type="button" onclick="file.saveFile(getText('save_format'), getInt('save_indent'))" value="Save" />
						<select id="save_format">
							<option value="netjson_netgraph">NetJSON NetworkGraph</option>
							<option value="meshviewer">Meshviewer meshviewer.json</option>
							<option value="meshviewer_graph">Meshviewer graph.json</option>
							<option value="meshviewer_nodes">Meshviewer nodes.json</option>
						</select>
					</div>
					<div class="enum">
						<div>
						<label>Indentation:</label>
						<select id="save_indent">
							<option value="-2">Tabs</option>
							<option value="-1">None</option>
							<option value="2" selected="selected">2 Spaces</option>
							<option value="4">4 Spaces</option>
						</select>
						</div>
					</div>
				</fieldset>

				<fieldset>
					<legend>Load Algorithm</legend>
					<div class="enum">
						<input type="button" onclick="sim.setAlgorithm($('algorithm'));" value="Load" />
						<select id="algorithm">
							<option value="random" selected="selected">Random Routing</option>
							<option value="distance_vector">Distance Vector</option>
							<option value="game_of_life">Game Of Life</option>
							<option value="spring_coordinates">Spring Coordinates</option>
							<option value="distance_enumeration">Distance Enumeration</option>
							<option value="vivaldi">Vivaldi Coordinates</option>
						</select>
					</div>
				</fieldset>
				<fieldset>
					<legend>Test</legend>
					<div class="enum">
						<input type="button" onclick="send('/cmd/load_test', {name: 'test'}, function(){ globalUpdate(); });" value="Load" />
					</div>
				</fieldset>
			</div>

			<div id="show" class="tabcontent">
				<fieldset>
					<legend>Inspect</legend>
					<div class="enum">
						<label>Type:</label>
						<span id="show_type">-</span>
					</div>
					<div class="enum">
						<label>Path:</label>
						<span id="show_path">/</span>
					</div>
					<div class="equal">
						<input type="button" onclick="show.showSelectedObject()" value="Show" />
					</div>
					<div class="equal">
						<table>
							<thead>
								<tr>
									<th onclick="sortLexial(this)">Key</th>
									<th onclick="sortLexial(this)">Value</th>
								</tr>
							</thead>
							<tbody id="show_object_tbody">
							</tbody>
							<tr id="show_no_items">
								<td colspan="2">No Items</td>
							</tr>
						</table>
					</div>
				</fieldset>
			</div>

			<div id="edit" class="tabcontent">
				<fieldset>
					<legend>Select</legend>
					<div class="equal">
						<input type="button" onclick="graph.extendSelection()" value="extend" />
						<input type="button" onclick="graph.clearSelection()" value="unselect" />
						<input type="button" onclick="graph.removeSelection()" value="remove" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Modify</legend>
					<div class="equal">
						<input type="button" onclick="graph.connectSelectedNodes()" value="connect" />
						<input type="button" onclick="graph.disconnectSelectedNodes()" value="disconnect" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Misc</legend>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.connectInRange(getInt('connect_range'))" value="connectInRange" />
						</div>
						<div class="equal">
							<input type="number" id="connect_range" min="1" max="999" value="3" />
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.randomizePositions(getInt('positions_range'))" value="randomizePositions" />
						</div>
						<div class="equal">
							<input type="number" id="positions_range" min="1" max="999" value="3" />
						</div>
					</div>
				</fieldset>
				<fieldset>
					<legend>Add Primitives</legend>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addNodes(1)" value="Node" />
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addLine(getInt('line_n'), getBool('line_close'))" value="Line" />
						</div>
						<div class="equal">
							<input type="number" id="line_n" min="1" max="999" value="3" />
							<input type="checkbox" id="line_close" />
							<span>Loop</span>
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addStar(getInt('star_n'))" value="Star" />
						</div>
						<div class="equal">
							<input type="number" id="star_n" min="1" max="999" value="4" />
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addLattice4(getInt('lattice4_x'), getInt('lattice4_y'))" value="4-Lattice" />
						</div>
						<div class="equal">
							<input type="number" id="lattice4_x" min="1" max="999" value="3" />
							<span>x</span>
							<input type="number" id="lattice4_y" min="1" max="999" value="3" />
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addLattice8(getInt('lattice8_x'), getInt('lattice8_y'))" value="8-Lattice" />
						</div>
						<div class="equal">
							<input type="number" id="lattice8_x" min="1" max="999" value="3" />
							<span>x</span>
							<input type="number" id="lattice8_y" min="1" max="999" value="3" />
						</div>
					</div>
					<div class="enum">
						<div>
							<input type="button" onclick="edit.addTree(getInt('tree_c'), getInt('tree_d'))" value="Tree" />
						</div>
						<div class="equal">
							<input type="number" id="tree_c" min="1" max="999" value="8" />
							<label title="Add additional random connections to the tree.">Extra:</label>
							<input type="number" id="tree_d" min="0" max="999" value="0" />
						</div>
					</div>
				</fieldset>
				<fieldset>
					<legend>Link Parameters</legend>
					<div class="enum">
						<label>Quality:</label>
						<input type="number" id="quality_value" min="0" max="100" value="50" />
						<span>%</span>
						<select id="quality_generation">
							<option value="fixed">Fixed</option>
							<option value="random">Random</option>
						</select>
					</div>
					<div class="enum">
						<div>
							<label>Bandwidth:</label>
						</div>
						<div>
							<input type="number" id="bandwidth_value" min="0" max="100" value="50" />
						</div>
					</div>
					<div class="enum">
						<div>
							<label>Channel:</label>
						</div>
						<div>
							<input type="number" id="channel_value" min="0" max="100" value="0" />
						</div>
					</div>
					<div class="equal">
						<input type="button" onclick="edit.getLinkParameters('bandwidth_value', 'quality_value', 'channel_value')" value="Get" />
						<input type="button" onclick="edit.setLinkParameters('bandwidth_value', 'quality_value', 'quality_generation', 'channel_value')" value="Set" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Animation</legend>
					<div class="equal">
						<input type="button" onclick="graph.toggleAnimation()" value="toggle" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Miscellaneous</legend>
					<div class="equal">
						<input type="button" onclick="edit.removeUnconnected()" value="remove single" />
						<input type="button" onclick="graph.resetView()" value="reset view" />
						<input type="button" onclick="graph.removeGraph()" value="remove graph" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Graph Statistics</legend>
					<div class="enum">
						<label>Links:</label>
						<span id="graph_links_count">0</span>
					</div>
					<div class="enum">
						<label>Nodes:</label>
						<span id="graph_nodes_count">0</span>
					</div>
				</fieldset>
			</div>

			<div id="control" class="tabcontent">
				<fieldset>
					<legend title="Send a string to each selected node">Send Command</legend>
					<div class="enum">
						<input type="text" value="" id="command_request" />
						<input type="button" value="send" onclick="control.sendCommand(getText('command_request'))" />
					</div>
					<div class="equal">
						<textarea id="command_reply" rows="40" cols="55"></textarea>
					</div>
				</fieldset>
			</div>

			<div id="sim" class="tabcontent">
				<fieldset>
					<legend>Simulator</legend>
					<div class="equal">
						<select id="sim_steps" title="Steps to execute in succession">
							<option value="1">1</option>
							<option value="10">10</option>
							<option value="100">100</option>
							<option value="1000">1000</option>
							<option value="10000">10^4</option>
							<option value="100000">10^5</option>
						</select>
						<select id="sim_delay" title="Delay between single steps">
							<option value="0">0s</option>
							<option value="250">1/4s</option>
							<option value="500">1/2s</option>
							<option value="1000">1s</option>
							<option value="2000">2s</option>
							<option value="5000">5s</option>
						</select>
						<input type="button" onclick="sim.toggleRun(getInt('sim_steps'), getFloat('sim_delay'))" id="sim_toggle" value="Start" />
						<!--<input type="button" onclick="sim.updateGraph()" value="graph" />
						<input type="button" onclick="sim.updateStats()" value="state" />-->
						<input type="button" onclick="sim.reset()" value="reset" />
					</div>
					<div class="equal">
						<div>
							<label>Total Steps:</label>
							<span id="sim_steps_total">0</span>
						</div>
						<div>
							<label>Steps Duration:</label>
							<span id="sim_duration_total">0 ms</span>
						</div>
					</div>
				</fieldset>
				<fieldset>
					<legend>Algorithm Info</legend>
					<div id="algo_name">-</div>
					<div id="algo_description">-</div>
				</fieldset>
				<fieldset>
					<legend>Traffic Statistics</legend>
					<div class="enum">
						<label>Test Num:</label>
						<span id="test_num">0</span>
					</div>
					 <div class="enum">
						<label>Test Count:</label>
						<span id="test_count">0</span>
					</div>
					<div class="enum">
						<label>Sim Steps:</label>
						<span id="stepnums">-</span>
					</div>
					<div class="enum">
						<label>Test Cost:</label>
						<span id="test_packet_costs">0</span>
					</div>
					<div class="enum">
						<label>Comm Cost:</label>
						<span id="comm_packet_costs">0</span>
					</div>
					<div class="enum">
						<label>Deployed:</label>
						<span id="deployed_test_packets">0</span>
					</div>
					<div class="enum">
						<label>Received:</label>
						<span id="received_test_packets">0</span>
					</div>
				</fieldset>
				<fieldset>
					<legend>Misc</legend>
					<div class="equal">
						<input type="button" onclick="" value="To Fixed Positions" />
						<input type="button" onclick="" value="Disable Animation" />
					</div>
				</fieldset>
				<fieldset>
					<legend>Chart</legend>
					<div id="chart"></div>
				</fieldset>
			</div>
		</div>
		<div id="graph" class="graph">
		</div>
	</div>
	<noscript>
		<strong>JavaScript required</strong>
	</noscript>
</body>
</html>
